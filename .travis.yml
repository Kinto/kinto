dist: trusty
language: python
python: 3.5
cache: pip
services:
  - memcached
addons:
  postgresql: "9.5"
env:
  - TOX_ENV=py35
  - TOX_ENV=py35-raw
  - TOX_ENV=flake8
  - TOX_ENV=docs
install:
  - mkdir -p $HOME/bin
  - curl -fsSL https://testspace-client.s3.amazonaws.com/testspace-linux.tgz | tar -zxvf- -C $HOME/bin
  - testspace config url $TS_ORG.testspace.com
  - pip install tox
before_script:
  - echo "Pull request ${TRAVIS_PULL_REQUEST}"
  - sudo sed -i "s/fsync/#fsync/" /etc/postgresql/9.5/main/postgresql.conf
  - sudo /etc/init.d/postgresql restart
  - psql -c "CREATE DATABASE testdb ENCODING 'UTF8' TEMPLATE template0;" -U postgres
  - make version-file
script:
  - if [[ "${TOX_ENV}" =~ ^py ]] ; then
      tox -e $TOX_ENV -- --junit-xml=testresults.xml;
    else
      tox -e $TOX_ENV;
    fi
after_script:
  - if [[ "${TOX_ENV}" =~ ^py ]] ; then
      testspace [${TOX_ENV}]testresults.xml{tests};
    elif [[ "${ENV}" = "functional" ]] ; then
      testspace [${ENV}]testresults.xml{tests};
    fi
after_success:
  # Report coverage results to coveralls.io
  - pip install coveralls
  - coveralls

matrix:
  include:
    - python: 3.6
      env:
        - TOX_ENV=py36
    - env: ENV=functional
      before_install:
        - make install-dev
        - make install-postgres
      script:
        - make runkinto & sleep 5
        - make functional
